<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LandLens - Land Risk Assessment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .header {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: white;
            padding: 30px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .navbar {
            background: white;
            display: flex;
            justify-content: center;
            gap: 10px;
            border-bottom: 2px solid #e9ecef;
            padding: 10px 20px;
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 12px 18px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 8px 8px 0 0;
        }

        .nav-item .nav-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .nav-item:hover {
            color: #0066cc;
            background: #f9f9f9;
        }

        .nav-item.active {
            color: #0066cc;
            border-bottom-color: #0066cc;
            background: #f0f5ff;
        }

        .nav-item.disabled {
            opacity: 0.45;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(0.2);
        }

        .container {
            max-width: 1200px;
            min-width: 900px;
            margin: 0 auto;
            padding: 0;
            flex: 1;
            overflow: hidden;
            min-height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow: auto;

        .step-indicator {
            display: none;
        }

        .step-dot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            padding: 0;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.10);
            display: none;
            width: 100%;
            max-width: 900px;
            min-width: 600px;
            margin: 0 auto 32px auto;
            min-height: 0;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
        }

        .step-dot.completed .dot {
            background: #22863a;
            color: white;
            border-color: #22863a;
        }

        .step-label {
            font-size: 12px;
            color: #999;
            font-weight: 600;
        }

        .step-dot.active .step-label {
            color: #0066cc;
        }

        .step-dot.completed .step-label {
            color: #22863a;
        }

        .overview-section {
            background: linear-gradient(135deg, #eef3ff 0%, #f7f9fc 100%);
            color: #1a365d;
            padding: 32px 40px;
            border-radius: 16px;
            margin-bottom: 28px;
            border: 1px solid #e3e9f5;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            max-width: 900px;
            width: 100%;
        }

        .overview-hero {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            align-items: center;
            margin-bottom: 16px;
        }

        .overview-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #e6f0ff;
            color: #0b4ca2;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.3px;
            margin-bottom: 12px;
        }

        .overview-section h2 {
            font-size: 26px;
            margin-bottom: 10px;
        }

        .overview-section p {
            font-size: 14px;
            line-height: 1.7;
            margin-bottom: 10px;
            color: #334155;
        }

        .overview-highlight {
            background: #ffffff;
            border-radius: 12px;
            padding: 18px 20px;
            border: 1px solid #edf2f7;
            font-size: 15px;
            color: #334155;
            margin-bottom: 10px;
        }

        .overview-features {
            display: flex;
            flex-direction: row;
            gap: 18px;
            margin-top: 18px;
            justify-content: space-between;
        }

        .feature-item {
            background: #ffffff;
            padding: 18px 20px;
            border-radius: 10px;
            font-size: 15px;
            border: 1px solid #edf2f7;
            color: #334155;
            flex: 1 1 0;
            min-width: 220px;
        }

        .cta-center {
            display: block;
            width: 100%;
            max-width: 360px;
            margin: 26px auto 0;
            text-align: center;
        }

        .field-note {
            margin-top: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        .feature-item strong {
            display: block;
            margin-bottom: 5px;
        }

        .form-container {
            background: white;
            padding: 48px 56px 40px 56px;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.10);
            display: none;
            width: 100%;
            max-width: 900px;
            min-width: 600px;
            margin: 0 auto 32px auto;
            min-height: 0;
            flex: 1 1 auto;
            flex-direction: column;
            justify-content: space-between;
            height: calc(100vh - 180px); /* header + navbar + footer + margin */
            overflow: hidden;
        }

        .form-container.active {
            display: flex !important;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-container h2 {
            font-size: 24px;
            color: #1a365d;
            margin-bottom: 10px;
        }

        .form-container p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .print-template {
            display: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a365d;
            font-size: 14px;
        }

        .form-group input, .form-group select, .dropdown-search {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            width: 100%;
        }

        .form-group input:focus, .form-group select:focus, .dropdown-search:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .form-group input.error {
            border-color: #dc3545 !important;
            background-color: #fff5f5;
        }

        .error-text {
            display: none;
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            font-weight: 500;
        }

        .error-text.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dropdown-container {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .dropdown-search {
            cursor: pointer;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 8px;
        }

        .dropdown-search::after {
            content: "‚ñº";
            font-size: 12px;
            color: #666;
        }

        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dropdown-options.open {
            display: block;
        }

        .dropdown-option {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background 0.2s ease;
        }

        .dropdown-option:hover {
            background: #f0f0f0;
        }

        .dropdown-option.selected {
            background: #e6f0ff;
            color: #0066cc;
            font-weight: 600;
        }

        .dropdown-option.disabled {
            color: #999;
            cursor: not-allowed;
            background: #f9f9f9;
        }

        .dropdown-search-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .dropdown-search-input:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .no-options {
            padding: 10px 12px;
            color: #999;
            text-align: center;
            font-size: 13px;
        }

        .error-text {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
        }

        .price-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 30px;
            border-left: 4px solid #0066cc;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .price-total {
            border-top: 1px solid #ddd;
            padding-top: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #0066cc;
        }

        .discount-badge {
            display: inline-block;
            background: #22863a;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .payment-methods {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .payment-method-label {
            flex: 1;
            position: relative;
        }

        .payment-method-label input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .payment-method-label .method-name {
            display: block;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }

        .payment-method-label input[type="radio"]:checked + .method-name {
            border-color: #0066cc;
            background: #e6f0ff;
            font-weight: 600;
        }

        .checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            margin-bottom: 20px;
        }

        .checkbox-label input[type="checkbox"] {
            margin-top: 3px;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0052a3;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #efefef;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .processing {
            text-align: center;
            padding: 60px 40px;
            max-width: 700px;
            margin: 0 auto;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #0052a3);
            width: 0%;
            animation: progress 3s ease-in-out forwards;
        }

        @keyframes progress {
            from { width: 0%; }
            to { width: 100%; }
        }

        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .success-box {
            background: #e6f7ed;
            border: 2px solid #22863a;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
        }

        .success-box h3 {
            color: #1a365d;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .success-box p {
            color: #666;
            margin-bottom: 20px;
        }

        .report-details {
            background: white;
            padding: 32px 40px;
            border-radius: 12px;
            margin: 24px 0;
            text-align: left;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row .label {
            font-weight: 600;
            color: #333;
        }

        .cache-info {
            background: #e6f7ed;
            border-left: 4px solid #22863a;
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #22863a;
            font-size: 13px;
        }

        .footer {
            background: #1a365d;
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 13px;
            margin-top: auto;
            width: 100vw;
            position: fixed;
            left: 0;
            bottom: 0;
            z-index: 100;
        }

        @media (max-width: 1200px) {
            .container {
                min-width: 100vw;
                max-width: 100vw;
                padding: 0;
            }
            .form-container, .overview-section {
                min-width: 100vw;
                max-width: 100vw;
                border-radius: 0;
                padding-left: 10vw;
                padding-right: 10vw;
            }
        }
        @media (max-width: 900px) {
            .form-container, .overview-section {
                min-width: 100vw;
                max-width: 100vw;
                border-radius: 0;
                padding-left: 2vw;
                padding-right: 2vw;
            }
        }
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .button-group {
                flex-direction: column-reverse;
            }
            .form-container, .overview-section {
                padding: 12px 2vw;
                min-width: 100vw;
                max-width: 100vw;
                border-radius: 0;
            }
            .report-details {
                padding: 16px 2vw;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>üåæ LandLens</h1>
        <p>Land Risk Assessment & Caching System</p>
    </header>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-item active" data-tab="overview" onclick="switchTab('overview')">
            <img class="nav-icon" src="https://img.icons8.com/fluency/48/dashboard-layout.png" alt="Overview">
            <span>Overview</span>
        </div>
        <div class="nav-item" data-tab="land-details" onclick="switchTab('land-details')">
            <img class="nav-icon" src="https://img.icons8.com/fluency/48/marker.png" alt="Land Details">
            <span>Land Details</span>
        </div>
        <div class="nav-item" data-tab="payment" onclick="switchTab('payment')">
            <img class="nav-icon" src="https://img.icons8.com/fluency/48/bank-card-back-side.png" alt="Payment">
            <span>Payment</span>
        </div>
        <div class="nav-item" data-tab="results" onclick="switchTab('results')">
            <img class="nav-icon" src="https://img.icons8.com/fluency/48/combo-chart.png" alt="Results">
            <span>Results</span>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Tab 0: Overview -->
        <div class="form-container active" id="tab-overview">
            <div class="overview-section" style="flex:1 1 auto;">
                <div class="overview-hero">
                    <div>
                        <div class="overview-badge">AI Powered ‚Ä¢ Bihar Focused</div>
                        <h2>Welcome to LandLens</h2>
                        <p>Assess agricultural land risk in Bihar with AI-powered analysis. Know the water availability, soil health, flood risk, and other critical factors before investing.</p>
                        <p>Get a trusted, shareable report in minutes with verified insights.</p>
                    </div>
                    <div class="overview-highlight">
                        <strong>What you get</strong>
                        <ul style="margin: 10px 0 0 18px; line-height: 1.7;">
                            <li>Risk band and confidence score</li>
                            <li>Key findings on soil, flood, and water</li>
                            <li>Downloadable PDF report for sharing</li>
                        </ul>
                        <button type="button" class="btn btn-primary cta-center" style="margin-top:24px; margin-bottom:0;" onclick="switchTab('land-details')">
                            Get Started ‚Üí
                        </button>
                    </div>
                </div>

                <div class="overview-features">
                    <div class="feature-item">
                        <strong>üîç Smart Analysis</strong>
                        Get detailed risk assessment including water levels, soil quality, and environmental factors
                    </div>
                    <div class="feature-item">
                        <strong>‚ö° Fast Results</strong>
                        Get instant results or use cached analysis if the land was recently evaluated
                    </div>
                    <div class="feature-item">
                        <strong>üí∞ Affordable Pricing</strong>
                        Pay ‚Çπ25 for new analysis. Returning customers get 80% discount on repeat searches within 7 days
                    </div>
                </div>

                <div class="overview-highlight" style="margin-top: 18px;">
                    <strong>Find an existing report</strong>
                    <p style="margin: 8px 0 12px; font-size: 13px; color: #475569;">
                        Enter your report reference number to retrieve and print a previously generated report.
                    </p>
                    <div class="form-row" style="grid-template-columns: 1.2fr 0.5fr; margin-bottom: 10px;">
                        <div class="form-group">
                            <label for="reference-search-input">Reference No</label>
                            <input type="text" id="reference-search-input" placeholder="e.g., LR-BR-20260212-ABCDEF">
                        </div>
                        <div class="form-group" style="justify-content: flex-end;">
                            <button type="button" class="btn btn-primary" id="reference-search-btn" style="margin-top: 22px;">
                                Search Report
                            </button>
                        </div>
                    </div>
                    <div id="reference-search-result" class="field-note"></div>
                </div>
            </div>
            <button type="button" class="btn btn-primary cta-center" style="margin-top:32px; margin-bottom:0;" onclick="switchTab('land-details')">
                Get Started ‚Üí
            </button>
        </div>

        <!-- Tab 1: Land Details -->
        <div class="form-container" id="tab-land-details">
            <h2>Land Details</h2>
            <p>Enter the details of the land parcel you want to assess</p>
            <div id="cache-info"></div>

            <form id="landForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="district">District *</label>
                        <div class="dropdown-container" id="district-dropdown">
                            <input type="text" class="dropdown-search-input" id="district-search" placeholder="Search district...">
                            <div class="dropdown-options" id="district-options"></div>
                        </div>
                        <input type="hidden" id="district" name="district" required>
                        <span class="error-text" id="error-district"></span>
                    </div>
                    <div class="form-group">
                        <label for="circle">Circle/Block *</label>
                        <div class="dropdown-container" id="circle-dropdown">
                            <input type="text" class="dropdown-search-input" id="circle-search" placeholder="Select district first..." disabled>
                            <div class="dropdown-options" id="circle-options"></div>
                        </div>
                        <input type="hidden" id="circle" name="circle" required>
                        <span class="error-text" id="error-circle"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="village">Village/Mauza *</label>
                        <div class="dropdown-container" id="village-dropdown">
                            <input type="text" class="dropdown-search-input" id="village-search" placeholder="Select circle first..." disabled>
                            <div class="dropdown-options" id="village-options"></div>
                        </div>
                        <input type="hidden" id="village" name="village" required>
                        <span class="error-text" id="error-village"></span>
                    </div>
                    <div class="form-group">
                        <label for="ownerName">Owner Name (Optional)</label>
                        <input type="text" id="ownerName" name="ownerName" placeholder="e.g., John Doe">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="khata">Khata Number (Optional)</label>
                        <input type="text" id="khata" name="khata" placeholder="e.g., KH-12345">
                        <span class="error-text" id="error-khata"></span>
                    </div>
                    <div class="form-group">
                        <label for="khesra">Khesra Number <span style="color:#dc3545;">*</span></label>
                        <input type="text" id="khesra" name="khesra" placeholder="e.g., KH-SEC-001" required>
                        <span class="error-text" id="error-khesra"></span>
                    </div>
                </div>


                <div class="form-row">
                    <div class="form-group">
                        <label for="plotArea">Land Ownership Type (Optional)</label>
                        <select id="plotArea" name="plotArea">
                            <option value="">Select ownership type</option>
                            <option value="Purchased">Purchased land</option>
                            <option value="Ancestral">Ancestral property</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="switchTab('overview')">
                        ‚Üê Back
                    </button>
                    <button type="button" class="btn btn-primary" onclick="validateLandForm() && switchTab('payment')">
                        Next: Payment ‚Üí
                    </button>
                </div>
            </form>
        </div>

        <!-- Tab 2: Payment -->
        <div class="form-container" id="tab-payment">
            <h2>Payment & Delivery</h2>
            <p>Complete your payment and provide contact details</p>

            <div class="price-section">
                <h3 style="margin-bottom: 15px; color: #1a365d;">Order Summary</h3>
                <div id="discount-info"></div>
                <div class="price-row">
                    <span>Land Assessment</span>
                    <span id="price-display">‚Çπ25.00</span>
                </div>
                <div class="price-row price-total">
                    <span>Total Amount</span>
                    <span id="total-display">‚Çπ25.00</span>
                </div>
            </div>

            <form id="paymentForm">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="whatsapp">WhatsApp Number *</label>
                    <div style="display: flex;">
                        <span style="background: #f5f5f5; border: 1px solid #ddd; border-right: none; padding: 10px 10px; border-radius: 4px 0 0 4px; color: #666; font-size: 13px; font-weight: 600;">+91</span>
                        <input type="tel" id="whatsapp" name="whatsapp" placeholder="9876543210" maxlength="13" required style="border: 1px solid #ddd; border-left: none; border-radius: 0 4px 4px 0; flex: 1;">
                    </div>
                    <span class="error-text" id="error-whatsapp"></span>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
                    <span class="error-text" id="error-email"></span>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="margin-bottom: 10px; display: block; font-weight: 600; color: #1a365d; font-size: 14px;">Payment Method *</label>
                    <div class="payment-methods">
                        <label class="payment-method-label">
                            <input type="radio" name="paymentMethod" value="razorpay" checked>
                            <span class="method-name">üí≥ Razorpay</span>
                        </label>
                        <label class="payment-method-label">
                            <input type="radio" name="paymentMethod" value="paytm">
                            <span class="method-name">üì± Paytm</span>
                        </label>
                        <label class="payment-method-label">
                            <input type="radio" name="paymentMethod" value="cashfree">
                            <span class="method-name">üè¶ Cashfree</span>
                        </label>
                    </div>
                </div>

                <label class="checkbox-label">
                    <input type="checkbox" id="agree" required>
                    <span>I agree to the Terms of Service and Privacy Policy</span>
                </label>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="switchTab('land-details')">
                        ‚Üê Back
                    </button>
                    <button type="button" class="btn btn-primary" onclick="validatePaymentForm() && switchTab('results')">
                        Proceed to Pay ‚Üí
                    </button>
                </div>
            </form>
        </div>

        <!-- Tab 3: Processing/Results -->
        <div class="form-container" id="tab-results">
            <div class="processing">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="spinner"></div>
                <p style="color: #666; margin-bottom: 20px; margin-top: 20px;">Processing your land assessment...</p>
            </div>

            <div class="success-box" id="successBox" style="display: none;">
                <div class="success-icon">‚úÖ</div>
                <h3>Report Generated Successfully!</h3>
                <p>Your land assessment report has been generated and will be sent to your WhatsApp and Email.</p>

                <div class="report-details">
                    <div class="detail-row">
                        <span class="label">Land Location:</span>
                        <span id="result-location"></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Khata/Khesra:</span>
                        <span id="result-khata"></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">WhatsApp Number:</span>
                        <span id="result-whatsapp"></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Email Address:</span>
                        <span id="result-email"></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Report Validity:</span>
                        <span>7 Days</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Reference No:</span>
                        <span id="result-reference"></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Download Report:</span>
                        <a id="result-download" href="#" target="_blank" rel="noopener" download="LandRiskPro-Report.pdf" style="color: #0066cc; text-decoration: none; font-weight: 600;">Download PDF</a>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="resetForm()" style="margin-top: 20px;">
                    Start New Search
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>¬© 2026 LandLens. All rights reserved. | Smart Land Risk Assessment System with Caching</p>
    </footer>

    <script>
        const API_URL = 'http://localhost:8081/api';
        const BASE_URL = API_URL.replace(/\/api\/?$/, '');
        let currentData = {};
        let isoCached = false;

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.form-container').forEach(el => el.classList.remove('active'));

            // Show selected tab
            const tabId = `tab-${tabName}`;
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.classList.add('active');
            }

            // Activate nav item and disable others
            document.querySelectorAll('.nav-item').forEach(el => {
                const isActive = el.getAttribute('data-tab') === tabName;
                el.classList.toggle('active', isActive);
                el.classList.toggle('disabled', !isActive);
            });
        }

        function normalizeText(value) {
            return (value || '').toString().trim().toLowerCase();
        }

        function filterOptions(options, searchText) {
            if (!searchText) return options;
            const text = normalizeText(searchText);
            return options.filter(option => {
                const label = typeof option === 'string' ? option : option.label;
                const code = typeof option === 'string' ? '' : (option.code || option.value || '');
                return normalizeText(label).includes(text) || normalizeText(code).includes(text);
            });
        }

        function getSelectedLabel(inputId, searchId) {
            const input = document.getElementById(inputId);
            if (input?.dataset?.label) return input.dataset.label;
            const search = searchId ? document.getElementById(searchId) : null;
            return search?.value || input?.value || '';
        }

        function getSelectedDisplay(searchId, fallbackLabel) {
            const search = searchId ? document.getElementById(searchId) : null;
            return search?.value || fallbackLabel || '';
        }

        // Bihar administrative data structure
        let biharData = {};

        async function loadBiharData() {
            try {
                const response = await fetch('data/bihar_full_data.json', { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error(`Failed to load data (${response.status})`);
                }
                const payload = await response.json();
                biharData = payload || {};
            } catch (error) {
                console.error('Failed to load Bihar data:', error);
                biharData = {};
            }
        }

        function initializePaymentValidation() {
            // Re-check cache when email or whatsapp is entered
            const emailField = document.getElementById('email');
            const whatsappField = document.getElementById('whatsapp');

            if (emailField) {
                emailField.addEventListener('change', function() {
                    checkCache();
                });
            }

            if (whatsappField) {
                whatsappField.addEventListener('change', function() {
                    checkCache();
                });
            }
        }

        function initializeDropdowns() {
            // District dropdown
            const districtSearch = document.getElementById('district-search');
            const districtOptions = document.getElementById('district-options');
            const districtInput = document.getElementById('district');
            const circleSearch = document.getElementById('circle-search');
            const circleOptions = document.getElementById('circle-options');
            const circleInput = document.getElementById('circle');
            const villageSearch = document.getElementById('village-search');
            const villageOptions = document.getElementById('village-options');
            const villageInput = document.getElementById('village');
            
            // Populate districts
            const districtList = (biharData?.districts || [])
                .map(district => ({
                    label: (district.district_name || '').trim(),
                    code: district.district_code != null ? String(district.district_code) : '',
                    value: district.district_code != null ? String(district.district_code) : '',
                    blocks: Array.isArray(district.blocks) ? district.blocks : []
                }))
                .filter(district => district.label && district.value)
                .sort((a, b) => a.label.localeCompare(b.label, 'en', { sensitivity: 'base' }));

            const districtByCode = new Map(districtList.map(district => [district.value, district]));
            let blockByCode = new Map();
            let currentCircleList = [];
            let currentVillageList = [];

            if (!districtList.length) {
                districtSearch.disabled = true;
                districtSearch.placeholder = 'Data unavailable';
                districtOptions.innerHTML = '';
                return;
            }
            renderOptions(districtOptions, districtList, null);
            
            // District search and select
            districtSearch.addEventListener('click', function() {
                if (!this.disabled) {
                    districtOptions.classList.toggle('open');
                    this.focus();
                }
            });

            // Add search filtering for district
            districtSearch.addEventListener('input', function() {
                const filtered = filterOptions(districtList, this.value);
                renderOptions(districtOptions, filtered, null);
            });
            districtOptions.addEventListener('click', function(e) {
                if (e.target.classList.contains('dropdown-option')) {
                    const districtCode = e.target.dataset.value;
                    const districtLabel = e.target.dataset.label || e.target.textContent;
                    const displayText = e.target.textContent;
                    districtInput.value = districtCode;
                    districtInput.dataset.label = districtLabel;
                    districtInput.dataset.code = districtCode;
                    districtSearch.value = displayText;
                    districtOptions.classList.remove('open');
                    
                    // Update circles
                    const districtData = districtByCode.get(districtCode);
                    const circles = (districtData?.blocks || [])
                        .map(block => ({
                            label: (block.block_name || '').trim(),
                            code: block.block_code != null ? String(block.block_code) : '',
                            value: block.block_code != null ? String(block.block_code) : '',
                            villages: Array.isArray(block.villages) ? block.villages : []
                        }))
                        .filter(block => block.label && block.value)
                        .sort((a, b) => a.label.localeCompare(b.label, 'en', { sensitivity: 'base' }));

                    blockByCode = new Map(circles.map(block => [block.value, block]));
                    currentCircleList = circles;
                    currentVillageList = [];
                    renderOptions(circleOptions, circles, circleInput.value);
                    
                    // Enable circle dropdown
                    circleSearch.disabled = false;
                    circleSearch.placeholder = 'Search circle...';
                    circleSearch.value = '';
                    circleInput.value = '';
                    circleInput.dataset.label = '';
                    circleInput.dataset.code = '';
                    
                    // Clear village
                    villageInput.value = '';
                    villageInput.dataset.label = '';
                    villageInput.dataset.code = '';
                    villageSearch.value = '';
                    villageSearch.disabled = true;
                    villageSearch.placeholder = 'Select circle first...';
                    villageOptions.innerHTML = '';
                    
                    checkCache();
                }
            });

            // Circle dropdown
            circleSearch.addEventListener('click', function() {
                if (!this.disabled) {
                    circleOptions.classList.toggle('open');
                }
            });

            circleSearch.addEventListener('input', function() {
                if (this.disabled) return;
                const filtered = filterOptions(currentCircleList, this.value);
                renderOptions(circleOptions, filtered, circleInput.value);
                circleOptions.classList.add('open');
            });

            circleOptions.addEventListener('click', function(e) {
                if (e.target.classList.contains('dropdown-option')) {
                    const circleCode = e.target.dataset.value;
                    const circleLabel = e.target.dataset.label || e.target.textContent;
                    const displayText = e.target.textContent;
                    circleInput.value = circleCode;
                    circleInput.dataset.label = circleLabel;
                    circleInput.dataset.code = circleCode;
                    circleSearch.value = displayText;
                    circleOptions.classList.remove('open');
                    
                    // Update villages
                    const blockData = blockByCode.get(circleCode);
                    const villages = (blockData?.villages || [])
                        .map(village => ({
                            label: (village.village_name || '').trim(),
                            code: village.village_code != null ? String(village.village_code) : '',
                            value: village.village_code != null ? String(village.village_code) : ''
                        }))
                        .filter(village => village.label && village.value)
                        .sort((a, b) => a.label.localeCompare(b.label, 'en', { sensitivity: 'base' }));

                    currentVillageList = villages;
                    renderOptions(villageOptions, villages, villageInput.value);
                    
                    // Enable village dropdown
                    villageSearch.disabled = false;
                    villageSearch.placeholder = 'Search village...';
                    
                    // Clear village selection
                    villageInput.value = '';
                    villageInput.dataset.label = '';
                    villageInput.dataset.code = '';
                    villageSearch.value = '';
                    
                    checkCache();
                }
            });

            // Village dropdown
            villageSearch.addEventListener('click', function() {
                if (!this.disabled) {
                    villageOptions.classList.toggle('open');
                }
            });

            villageSearch.addEventListener('input', function() {
                if (this.disabled) return;
                const filtered = filterOptions(currentVillageList, this.value);
                renderOptions(villageOptions, filtered, villageInput.value);
                villageOptions.classList.add('open');
            });

            villageOptions.addEventListener('click', function(e) {
                if (e.target.classList.contains('dropdown-option')) {
                    const villageCode = e.target.dataset.value;
                    const villageLabel = e.target.dataset.label || e.target.textContent;
                    const displayText = e.target.textContent;
                    villageInput.value = villageCode;
                    villageInput.dataset.label = villageLabel;
                    villageInput.dataset.code = villageCode;
                    villageSearch.value = displayText;
                    villageOptions.classList.remove('open');
                    
                    checkCache();
                }
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-container')) {
                    document.querySelectorAll('.dropdown-options.open').forEach(el => {
                        el.classList.remove('open');
                    });
                }
            });
        }

        function renderOptions(container, options, selected) {
            container.innerHTML = '';
            if (options.length === 0) {
                container.innerHTML = '<div class="no-options">No options available</div>';
                return;
            }
            options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'dropdown-option';
                
                // Support both string and object formats
                const label = typeof option === 'string' ? option : option.label;
                const code = typeof option === 'string' ? '' : (option.code || '');
                const displayText = code ? `${label} (${code})` : label;
                const value = typeof option === 'string' ? option : (option.value || option.label);
                
                if (normalizeText(selected) === normalizeText(value) || normalizeText(selected) === normalizeText(label)) {
                    div.classList.add('selected');
                }
                div.textContent = displayText;
                div.dataset.value = value || label;
                div.dataset.label = label;
                if (code) {
                    div.dataset.code = code;
                }
                container.appendChild(div);
            });
        }

        async function checkCache() {
            const khata = document.getElementById('khata').value;
            const khesra = document.getElementById('khesra').value;
            const district = getSelectedLabel('district', 'district-search');
            const email = document.getElementById('email')?.value || '';
            const whatsapp = document.getElementById('whatsapp')?.value || '';

            if (!district || !khesra) return;

            try {
                // Include email and whatsapp in cache check for user-based discount eligibility
                // Discount (‚Çπ5) ONLY for same user (email + whatsapp match)
                // Different users get full price (‚Çπ25) but may reuse cached PDF
                let url = `${API_URL}/orders/cache/check?district=${encodeURIComponent(district)}&khata=${encodeURIComponent(khata)}&khesra=${encodeURIComponent(khesra)}`;
                if (email) url += `&email=${encodeURIComponent(email)}`;
                if (whatsapp) url += `&whatsapp=${encodeURIComponent(whatsapp)}`;

                const response = await fetch(url);
                if (response.ok) {
                    const cacheInfo = await response.json();
                    isoCached = cacheInfo.discountEligible;  // true = same user, false = different user
                    
                    if (cacheInfo.discountEligible) {
                        // Same user - eligible for discount
                        document.getElementById('cache-info').innerHTML = `
                            <div class="cache-info">
                                ‚úì You searched this land before! <strong>80% discount applied!</strong>
                            </div>
                        `;
                    } else {
                        // Different user - no discount but cached results available
                        document.getElementById('cache-info').innerHTML = `
                            <div class="cache-info">
                                ‚Ñπ This land was analyzed before. Results available (full price).
                            </div>
                        `;
                    }
                    updatePrice(cacheInfo.discountEligible);
                } else {
                    isoCached = false;
                    document.getElementById('cache-info').innerHTML = '';
                    updatePrice(false);
                }
            } catch (error) {
                console.log('No cache found or error checking cache:', error);
                isoCached = false;
                document.getElementById('cache-info').innerHTML = '';
                updatePrice(false);
            }
        }

        function updatePrice(cached) {
            const priceAmount = cached ? 5 : 25;
            const pricePaise = cached ? 500 : 2500;
            
            document.getElementById('price-display').textContent = `‚Çπ${priceAmount}.00`;
            document.getElementById('total-display').textContent = `‚Çπ${priceAmount}.00`;

            if (cached) {
                document.getElementById('discount-info').innerHTML = `
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px 15px; margin-bottom: 15px; border-radius: 4px;">
                        <span class="discount-badge">CACHED RESULT - 80% OFF</span>
                        <p style="margin: 5px 0 0 0; color: #856404; font-size: 13px;">You saved ‚Çπ20! Getting cached results...</p>
                    </div>
                `;
            } else {
                document.getElementById('discount-info').innerHTML = '';
            }

            currentData.amountPaise = pricePaise;
        }

        function goToStep(step) {
            // Handle back button
            if (step === -1) {
                // Go back to previous step
                const currentStep = parseInt(document.querySelector('.form-container.active').id.replace('step-', ''));
                if (currentStep > 0) {
                    step = currentStep - 1;
                } else {
                    return;
                }
            }

            if (step === 1) {
                // Validate land details form
                const form = document.getElementById('landForm');
                const formData = new FormData(form);

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const districtLabel = getSelectedLabel('district', 'district-search');
                const circleLabel = getSelectedLabel('circle', 'circle-search');
                const villageLabel = getSelectedLabel('village', 'village-search');
                const districtDisplay = getSelectedDisplay('district-search', districtLabel);
                const circleDisplay = getSelectedDisplay('circle-search', circleLabel);
                const villageDisplay = getSelectedDisplay('village-search', villageLabel);

                currentData = {
                    district: districtDisplay,
                    circle: circleDisplay,
                    village: villageDisplay,
                    districtName: districtLabel,
                    circleName: circleLabel,
                    villageName: villageLabel,
                    districtCode: document.getElementById('district').value,
                    circleCode: document.getElementById('circle').value,
                    villageCode: document.getElementById('village').value,
                    khata: document.getElementById('khata').value,
                    khesra: document.getElementById('khesra').value,
                    ownerName: document.getElementById('ownerName').value || '',
                    plotArea: document.getElementById('plotArea').value || '',
                };
            } else if (step === 2) {
                // Validate payment form
                const whatsapp = document.getElementById('whatsapp').value;
                const email = document.getElementById('email').value;
                const agree = document.getElementById('agree').checked;

                if (!/^[0-9]{10,13}$/.test(whatsapp)) {
                    const whatsappError = document.getElementById('error-whatsapp');
                    whatsappError.textContent = 'Valid WhatsApp number required';
                    whatsappError.classList.add('show');
                    document.getElementById('whatsapp').classList.add('error');
                    return;
                } else {
                    document.getElementById('error-whatsapp').classList.remove('show');
                    document.getElementById('whatsapp').classList.remove('error');
                }

                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    const emailError = document.getElementById('error-email');
                    emailError.textContent = 'Valid email required';
                    emailError.classList.add('show');
                    document.getElementById('email').classList.add('error');
                    return;
                } else {
                    document.getElementById('error-email').classList.remove('show');
                    document.getElementById('email').classList.remove('error');
                }

                if (!agree) {
                    alert('Please agree to the terms');
                    return;
                }

                currentData.whatsappNumber = whatsapp;
                currentData.emailAddress = email;
                currentData.paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

                // Simulate processing
                simulateProcessing();
            }

            updateStepIndicator(step);
            document.querySelectorAll('.form-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
        }

        function validateLandForm() {
            const khata = document.getElementById('khata').value;
            const khesra = document.getElementById('khesra').value;
            const district = document.getElementById('district').value;
            const circle = document.getElementById('circle').value;
            const village = document.getElementById('village').value;

            const errors = [];
            if (!district) {
                document.getElementById('error-district').textContent = 'District is required';
                document.getElementById('error-district').classList.add('show');
                document.getElementById('district-search').classList.add('error');
                errors.push('district');
            } else {
                document.getElementById('error-district').classList.remove('show');
                document.getElementById('district-search').classList.remove('error');
            }

            if (!circle) {
                document.getElementById('error-circle').textContent = 'Circle/Block is required';
                document.getElementById('error-circle').classList.add('show');
                document.getElementById('circle-search').classList.add('error');
                errors.push('circle');
            } else {
                document.getElementById('error-circle').classList.remove('show');
                document.getElementById('circle-search').classList.remove('error');
            }

            if (!village) {
                document.getElementById('error-village').textContent = 'Village is required';
                document.getElementById('error-village').classList.add('show');
                document.getElementById('village-search').classList.add('error');
                errors.push('village');
            } else {
                document.getElementById('error-village').classList.remove('show');
                document.getElementById('village-search').classList.remove('error');
            }

            if (!khesra) {
                document.getElementById('error-khesra').textContent = 'Khesra number is required';
                document.getElementById('error-khesra').classList.add('show');
                document.getElementById('khesra').classList.add('error');
                errors.push('khesra');
            } else {
                document.getElementById('error-khesra').classList.remove('show');
                document.getElementById('khesra').classList.remove('error');
                document.getElementById('error-khata').classList.remove('show');
                document.getElementById('khata').classList.remove('error');
            }

            if (errors.length > 0) return false;

            const districtLabel = getSelectedLabel('district', 'district-search');
            const circleLabel = getSelectedLabel('circle', 'circle-search');
            const villageLabel = getSelectedLabel('village', 'village-search');
            const districtDisplay = getSelectedDisplay('district-search', districtLabel);
            const circleDisplay = getSelectedDisplay('circle-search', circleLabel);
            const villageDisplay = getSelectedDisplay('village-search', villageLabel);

            currentData = {
                district: districtDisplay,
                circle: circleDisplay,
                village: villageDisplay,
                districtName: districtLabel,
                circleName: circleLabel,
                villageName: villageLabel,
                districtCode: district,
                circleCode: circle,
                villageCode: village,
                khata: khata,
                khesra: khesra,
                ownerName: document.getElementById('ownerName').value || '',
                plotArea: document.getElementById('plotArea').value || '',
            };
            return true;
        }

        function validatePaymentForm() {
            const whatsapp = document.getElementById('whatsapp').value.trim();
            const email = document.getElementById('email').value.trim();
            const agree = document.getElementById('agree').checked;
            let isValid = true;

            if (!/^[0-9]{10,13}$/.test(whatsapp)) {
                const whatsappError = document.getElementById('error-whatsapp');
                whatsappError.textContent = 'Valid WhatsApp number required';
                whatsappError.classList.add('show');
                document.getElementById('whatsapp').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('error-whatsapp').classList.remove('show');
                document.getElementById('whatsapp').classList.remove('error');
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                const emailError = document.getElementById('error-email');
                emailError.textContent = 'Valid email required';
                emailError.classList.add('show');
                document.getElementById('email').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('error-email').classList.remove('show');
                document.getElementById('email').classList.remove('error');
            }

            if (!agree) {
                alert('Please agree to the terms');
                isValid = false;
            }

            if (!isValid) return false;

            currentData.whatsappNumber = whatsapp;
            currentData.emailAddress = email;
            currentData.paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

            // Simulate processing
            simulateProcessing();
            return true;
        }

        function updateStepIndicator(step) {
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === step) {
                    dot.classList.add('active');
                } else if (index < step) {
                    dot.classList.add('completed');
                    dot.querySelector('.dot').textContent = '‚úì';
                } else {
                    dot.querySelector('.dot').textContent = index + 1;
                }
            });
        }

        async function simulateProcessing() {
            document.querySelector('.processing').style.display = 'block';
            document.getElementById('successBox').style.display = 'none';

            const khataDisplay = currentData.khata ? currentData.khata : '‚Äî';
            const khesraDisplay = currentData.khesra ? currentData.khesra : '‚Äî';

            try {
                const orderPayload = {
                    district: currentData.districtName || currentData.district,
                    circle: currentData.circleName || currentData.circle,
                    village: currentData.villageName || currentData.village,
                    khata: currentData.khata || '',
                    khesra: currentData.khesra || '',
                    ownerName: currentData.ownerName || '',
                    plotArea: currentData.plotArea || '',
                    whatsappNumber: currentData.whatsappNumber,
                    emailAddress: currentData.emailAddress
                };

                const createRes = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderPayload)
                });

                if (!createRes.ok) {
                    throw new Error('Order creation failed');
                }

                const orderData = await createRes.json();
                const mockPayRes = await fetch(`${API_URL}/orders/${orderData.orderId}/mock-pay`, {
                    method: 'POST'
                });

                if (!mockPayRes.ok) {
                    throw new Error('Payment failed');
                }

                const paymentData = await mockPayRes.json();

                document.querySelector('.processing').style.display = 'none';
                document.getElementById('successBox').style.display = 'block';

                currentData.referenceNo = paymentData.referenceNo || paymentData.referenceId || '';
                if (!currentData.referenceNo && paymentData.verifyUrl) {
                    try {
                        const verifyUrl = paymentData.verifyUrl.startsWith('http')
                            ? paymentData.verifyUrl
                            : `${BASE_URL}${paymentData.verifyUrl}`;
                        const verifyRes = await fetch(verifyUrl);
                        if (verifyRes.ok) {
                            const summary = await verifyRes.json();
                            currentData.referenceNo = summary.referenceNo || summary.referenceId || currentData.referenceNo;
                        }
                    } catch (e) {
                        // ignore fallback errors
                    }
                }
                document.getElementById('result-location').textContent =
                    `${currentData.village}, ${currentData.circle}, ${currentData.district}`;
                document.getElementById('result-khata').textContent =
                    `${khataDisplay} / ${khesraDisplay}`;
                document.getElementById('result-whatsapp').textContent =
                    `+91${currentData.whatsappNumber}`;
                document.getElementById('result-email').textContent =
                    currentData.emailAddress;
                document.getElementById('result-reference').textContent =
                    currentData.referenceNo || '‚Äî';

                const downloadLink = document.getElementById('result-download');
                const reportUrl = `${API_URL}/reports/${paymentData.reportId}/download`;
                downloadLink.href = reportUrl;
            } catch (error) {
                document.querySelector('.processing').style.display = 'none';
                document.getElementById('successBox').style.display = 'block';
                document.getElementById('result-location').textContent =
                    `${currentData.village}, ${currentData.circle}, ${currentData.district}`;
                document.getElementById('result-khata').textContent =
                    `${khataDisplay} / ${khesraDisplay}`;
                document.getElementById('result-whatsapp').textContent =
                    `+91${currentData.whatsappNumber}`;
                document.getElementById('result-email').textContent =
                    currentData.emailAddress;
                document.getElementById('result-reference').textContent = '‚Äî';
                document.getElementById('result-download').href = '#';
                console.warn('Report generation failed.');
            }
        }

        function buildPrintableReportHtml() {
            const now = new Date();
            const khataDisplay = currentData.khata ? currentData.khata : '‚Äî';
            const khesraDisplay = currentData.khesra ? currentData.khesra : '‚Äî';
            const reportId = currentData.referenceNo || 'LR-UNAVAILABLE';
            const reportDate = now.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });

            return `
                <html>
                <head>
                    <title>LandLens Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 24px; color: #1f2937; }
                        .card { border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
                        .header { background: linear-gradient(135deg, #0047ab 0%, #0077ff 100%); color: #fff; padding: 18px 22px; display: flex; justify-content: space-between; align-items: center; }
                        .brand { font-weight: 700; font-size: 18px; }
                        .meta { text-align: right; font-size: 12px; line-height: 1.5; }
                        .section { padding: 18px 22px; border-top: 1px solid #eef2f7; }
                        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; }
                        .tile { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; font-size: 13px; }
                        .tile h4 { margin: 0 0 8px 0; font-size: 12px; color: #0f2a4d; text-transform: uppercase; letter-spacing: 0.4px; }
                        .pill { display: inline-block; background: #e6f0ff; color: #084298; border-radius: 999px; padding: 6px 12px; font-size: 12px; font-weight: 700; margin-right: 8px; }
                        .footer { font-size: 12px; color: #6b7280; border-top: 1px dashed #e5e7eb; padding-top: 12px; }
                    </style>
                </head>
                <body>
                    <div class="card">
                        <div class="header">
                            <div class="brand">üåæ LandLens Report</div>
                            <div class="meta">
                                <div>Reference No: ${reportId}</div>
                                <div>Date: ${reportDate}</div>
                                <div>Validity: 7 Days</div>
                            </div>
                        </div>
                        <div class="section">
                            <span class="pill">Risk Band: MEDIUM</span>
                            <span class="pill">Risk Score: 74/100</span>
                            <span class="pill">Confidence: HIGH</span>
                        </div>
                        <div class="section grid">
                            <div class="tile">
                                <h4>Parcel Details</h4>
                                <div><strong>District:</strong> ${currentData.district || '‚Äî'}</div>
                                <div><strong>Circle:</strong> ${currentData.circle || '‚Äî'}</div>
                                <div><strong>Village:</strong> ${currentData.village || '‚Äî'}</div>
                                <div><strong>Khata/Khesra:</strong> ${khataDisplay} / ${khesraDisplay}</div>
                                <div><strong>Land Ownership:</strong> ${currentData.plotArea || '‚Äî'}</div>
                            </div>
                            <div class="tile">
                                <h4>Owner & Contact</h4>
                                <div><strong>Owner Name:</strong> ${currentData.ownerName || '‚Äî'}</div>
                                <div><strong>WhatsApp:</strong> +91${currentData.whatsappNumber || '‚Äî'}</div>
                                <div><strong>Email:</strong> ${currentData.emailAddress || '‚Äî'}</div>
                            </div>
                            <div class="tile">
                                <h4>Key Findings</h4>
                                <div>Water availability: Moderate</div>
                                <div>Flood exposure: Low</div>
                                <div>Soil health: Stable</div>
                                <div>Legal risks: Low</div>
                            </div>
                        </div>
                        <div class="section footer">
                            This is an auto-generated report from LandLens. Use the PDF for official verification.
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        async function openReportDownload(reportUrl) {
            if (!reportUrl || reportUrl === '#') {
                alert('Report link is not ready yet. Please try again.');
                return;
            }

            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(buildPrintableReportHtml());
                printWindow.document.close();
            }

            try {
                const response = await fetch(reportUrl);
                if (!response.ok) {
                    throw new Error('Download failed');
                }
                const blob = await response.blob();
                const fileUrl = URL.createObjectURL(blob);

                const tempLink = document.createElement('a');
                tempLink.href = fileUrl;
                tempLink.download = 'LandRiskPro-Report.pdf';
                document.body.appendChild(tempLink);
                tempLink.click();
                tempLink.remove();

                if (printWindow) {
                    printWindow.document.title = 'LandLens Report';
                    printWindow.focus();
                    setTimeout(() => printWindow.print(), 600);
                }

                setTimeout(() => URL.revokeObjectURL(fileUrl), 10000);
            } catch (error) {
                if (printWindow) {
                    printWindow.close();
                }
                alert('Unable to download the report. Please try again.');
            }
        }

        async function handleReportDownload(event) {
            event.preventDefault();
            const downloadLink = document.getElementById('result-download');
            const reportUrl = downloadLink?.href;
            await openReportDownload(reportUrl);
        }

        async function handleReferenceSearch() {
            const input = document.getElementById('reference-search-input');
            const result = document.getElementById('reference-search-result');
            const referenceId = input?.value?.trim();

            if (!referenceId) {
                result.textContent = 'Enter a reference number to search.';
                return;
            }

            result.textContent = 'Searching report...';

            try {
                const response = await fetch(`${API_URL}/reports/by-ref/${encodeURIComponent(referenceId)}`);
                if (!response.ok) {
                    throw new Error('Report not found');
                }

                const data = await response.json();
                let summary = {};
                if (typeof data.summaryJson === 'string') {
                    summary = JSON.parse(data.summaryJson || '{}');
                } else if (data.summaryJson) {
                    summary = data.summaryJson;
                }

                currentData = {
                    ...currentData,
                    district: summary.district || '',
                    circle: summary.circle || '',
                    village: summary.village || '',
                    khata: summary.khata || '',
                    khesra: summary.khesra || '',
                    ownerName: summary.ownerName || summary.owner || '',
                    whatsappNumber: summary.whatsappNumber || summary.whatsapp || summary.contactNumber || '',
                    emailAddress: summary.emailAddress || summary.email || '',
                    plotArea: summary.ownershipType || summary.plotArea || '',
                    referenceNo: data.referenceNo || summary.referenceNo || referenceId
                };

                const downloadUrl = data.downloadUrl
                    ? `${BASE_URL}${data.downloadUrl}`
                    : `${API_URL}/reports/by-ref/${encodeURIComponent(referenceId)}/download`;
                const verifyUrl = data.verifyUrl
                    ? `${BASE_URL}${data.verifyUrl}`
                    : `${API_URL}/reports/${data.reportId}/verify?code=`;

                result.innerHTML = `Report found for <strong>${currentData.district}</strong>. ` +
                    `<a href="#" id="reference-download-link" style="color:#0066cc;font-weight:600;">Download PDF</a>` +
                    ` | <a href="${verifyUrl}" target="_blank" rel="noopener" style="color:#0066cc;font-weight:600;">Verify</a>`;
                const link = document.getElementById('reference-download-link');
                if (link) {
                    link.addEventListener('click', async (event) => {
                        event.preventDefault();
                        await openReportDownload(downloadUrl);
                    });
                }

            } catch (error) {
                result.textContent = 'No report found for this reference number.';
            }
        }

        function resetForm() {
            document.getElementById('landForm').reset();
            document.getElementById('paymentForm').reset();
            currentData = {};
            isoCached = false;
            document.querySelector('.processing').style.display = 'block';
            document.getElementById('successBox').style.display = 'none';
            document.getElementById('cache-info').innerHTML = '';
            updatePrice(false);
            switchTab('overview');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            switchTab('overview');
            updatePrice(false);
            await loadBiharData();
            initializeDropdowns();
            initializePaymentValidation();
            const downloadButton = document.getElementById('result-download');
            if (downloadButton) {
                downloadButton.addEventListener('click', handleReportDownload);
            }
            const referenceButton = document.getElementById('reference-search-btn');
            if (referenceButton) {
                referenceButton.addEventListener('click', handleReferenceSearch);
            }
        });
    </script>
</body>
</html>
